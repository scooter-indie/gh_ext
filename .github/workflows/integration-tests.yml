name: Integration Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of tests to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - integration
          - uat

# Prevent concurrent runs against the same test fixtures
concurrency:
  group: integration-tests
  cancel-in-progress: false

env:
  TEST_PROJECT_OWNER: scooter-indie
  TEST_PROJECT_NUMBER: "29"
  TEST_REPO_OWNER: scooter-indie
  TEST_REPO_NAME: gh-pmu-test

jobs:
  integration:
    if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'integration' }}
    runs-on: ubuntu-latest
    environment: integration-tests

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Install gh-pmu extension
        run: |
          go build -o gh-pmu .
          mkdir -p ~/.local/bin
          mv gh-pmu ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure gh CLI
        run: |
          echo "${{ secrets.TEST_GH_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Run integration tests
        env:
          TEST_GH_TOKEN: ${{ secrets.TEST_GH_TOKEN }}
        run: |
          go test -v -tags=integration -timeout=10m ./... 2>&1 | tee integration-test-output.txt
        continue-on-error: true

      - name: Upload test output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: integration-test-output
          path: integration-test-output.txt

      - name: Check test results
        run: |
          if grep -q "^FAIL" integration-test-output.txt; then
            echo "Integration tests failed"
            exit 1
          fi
          echo "Integration tests passed"

  uat:
    if: ${{ github.event.inputs.test_type == 'all' || github.event.inputs.test_type == 'uat' }}
    runs-on: ubuntu-latest
    environment: integration-tests
    needs: [integration]
    # Run UAT even if integration is skipped (when test_type is 'uat')
    # But wait for integration if both are running
    if: ${{ always() && (github.event.inputs.test_type == 'uat' || needs.integration.result == 'success' || needs.integration.result == 'skipped') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Install gh-pmu extension
        run: |
          go build -o gh-pmu .
          mkdir -p ~/.local/bin
          mv gh-pmu ~/.local/bin/
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Configure gh CLI
        run: |
          echo "${{ secrets.TEST_GH_TOKEN }}" | gh auth login --with-token
          gh auth status

      - name: Run UAT tests
        env:
          TEST_GH_TOKEN: ${{ secrets.TEST_GH_TOKEN }}
        run: |
          go test -v -tags=uat -timeout=15m ./test/uat/... 2>&1 | tee uat-test-output.txt || true
        continue-on-error: true

      - name: Upload UAT output
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: uat-test-output
          path: uat-test-output.txt

  cleanup:
    runs-on: ubuntu-latest
    environment: integration-tests
    needs: [integration, uat]
    if: always()

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure gh CLI
        run: |
          echo "${{ secrets.TEST_GH_TOKEN }}" | gh auth login --with-token

      - name: Cleanup test issues
        run: |
          echo "Cleaning up any orphaned test issues..."
          # Find and close issues created by tests (title starts with "Test Issue")
          gh issue list --repo $TEST_REPO_OWNER/$TEST_REPO_NAME \
            --search "Test Issue in:title" \
            --state open \
            --json number \
            --jq '.[].number' | while read -r num; do
              echo "Closing orphaned test issue #$num"
              gh issue close --repo $TEST_REPO_OWNER/$TEST_REPO_NAME "$num" --reason "not_planned" || true
          done
          echo "Cleanup complete"
